{"version":3,"file":"extension.js","sources":["../src/extension.ts"],"sourcesContent":["import * as vscode from 'vscode';\nimport * as path from 'path';\nimport * as fs from 'fs';\n\n// 支持的图片格式\nconst IMAGE_EXTENSIONS = ['.svg', '.png', '.jpg', '.jpeg', '.gif', '.webp', '.ico', '.bmp'];\n\ninterface ImageFile {\n  name: string;\n  path: string;\n  uri: string;\n  type: 'svg' | 'image';\n  extension: string;\n}\n\nexport function activate(context: vscode.ExtensionContext) {\n  const disposable = vscode.commands.registerCommand('SVGViewer.open', async (uri: vscode.Uri) => {\n    let targetPath: string;\n\n    if (uri) {\n      targetPath = uri.fsPath;\n    } else {\n      const activeEditor = vscode.window.activeTextEditor;\n      if (activeEditor) {\n        targetPath = activeEditor.document.uri.fsPath;\n      } else {\n        vscode.window.showErrorMessage('No file or folder selected');\n        return;\n      }\n    }\n\n    const stat = fs.statSync(targetPath);\n    let images: ImageFile[] = [];\n\n    if (stat.isDirectory()) {\n      images = await scanDirectory(targetPath, context);\n    } else {\n      const ext = path.extname(targetPath).toLowerCase();\n      const imageFile = createImageFile(targetPath, context);\n      if (imageFile) {\n        images = [imageFile];\n      }\n    }\n\n    if (images.length === 0) {\n      vscode.window.showInformationMessage('No images found in the selected location');\n      return;\n    }\n\n    const panel = vscode.window.createWebviewPanel(\n      'svgViewer',\n      `Image Viewer - ${path.basename(targetPath)}`,\n      vscode.ViewColumn.One,\n      {\n        enableScripts: true,\n        retainContextWhenHidden: true,\n        localResourceRoots: [\n          vscode.Uri.file(path.join(context.extensionPath, 'dist')),\n          vscode.Uri.file(path.dirname(targetPath))\n        ]\n      }\n    );\n\n    panel.webview.onDidReceiveMessage(\n      message => {\n        console.log('Extension received message:', message);\n        if (message.command === 'open-svg') {\n          const svgUri = vscode.Uri.file(message.path);\n          openSvgInEditor(svgUri);\n        }\n        if (message.command === 'open-web') {\n          vscode.env.openExternal(vscode.Uri.parse(message.url));\n        }\n      },\n      undefined,\n      context.subscriptions\n    );\n\n    panel.webview.html = getWebviewContent(panel.webview, context, images);\n  });\n\n  context.subscriptions.push(disposable);\n}\n\nfunction openSvgInEditor(svgUri: vscode.Uri) {\n  vscode.workspace.openTextDocument(svgUri).then(doc => {\n    vscode.window.showTextDocument(doc, {\n      preview: false,  // 如果为 true，重复打开同一个文件会复用 tab\n      viewColumn: vscode.ViewColumn.One // 打开在第一个编辑器列\n    });\n  }, err => {\n    vscode.window.showErrorMessage(`无法打开 SVG: ${err}`);\n  });\n}\n\nasync function scanDirectory(dirPath: string, context: vscode.ExtensionContext): Promise<ImageFile[]> {\n  const images: ImageFile[] = [];\n\n  async function scan(dir: string) {\n    const entries = fs.readdirSync(dir, { withFileTypes: true });\n\n    for (const entry of entries) {\n      const fullPath = path.join(dir, entry.name);\n\n      if (entry.isDirectory()) {\n        await scan(fullPath);\n      } else if (entry.isFile()) {\n        const imageFile = createImageFile(fullPath, context);\n        if (imageFile) {\n          images.push(imageFile);\n        }\n      }\n    }\n  }\n\n  await scan(dirPath);\n  return images;\n}\n\nfunction createImageFile(filePath: string, context: vscode.ExtensionContext): ImageFile | null {\n  const ext = path.extname(filePath).toLowerCase();\n\n  if (IMAGE_EXTENSIONS.includes(ext)) {\n    return {\n      name: path.basename(filePath),\n      path: filePath,\n      uri: filePath,\n      type: ext === '.svg' ? 'svg' : 'image',\n      extension: ext.slice(1)\n    };\n  }\n\n  return null;\n}\n\nfunction getWebviewContent(webview: vscode.Webview, context: vscode.ExtensionContext, images: ImageFile[]): string {\n  const scriptUri = webview.asWebviewUri(\n    vscode.Uri.file(path.join(context.extensionPath, 'dist', 'webview', 'index.js'))\n  );\n  const styleUri = webview.asWebviewUri(\n    vscode.Uri.file(path.join(context.extensionPath, 'dist', 'webview', 'index.css'))\n  );\n\n  // 转换图片路径为 webview URI\n  const imagesWithUri = images.map(img => ({\n    ...img,\n    uri: webview.asWebviewUri(vscode.Uri.file(img.path)).toString()\n  }));\n\n  const nonce = getNonce();\n\n  return `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <meta http-equiv=\"Content-Security-Policy\" content=\"default-src 'none'; style-src ${webview.cspSource} 'unsafe-inline'; script-src 'nonce-${nonce}'; img-src ${webview.cspSource} data: https:; font-src ${webview.cspSource};\">\n  <link rel=\"stylesheet\" href=\"${styleUri}\">\n  <title>Image Viewer</title>\n</head>\n<body>\n  <div id=\"root\"></div>\n  <script nonce=\"${nonce}\">\n    window.__IMAGES__ = ${JSON.stringify(imagesWithUri)};\n  </script>\n  <script nonce=\"${nonce}\" src=\"${scriptUri}\"></script>\n</body>\n</html>`;\n}\n\nfunction getNonce(): string {\n  let text = '';\n  const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n  for (let i = 0; i < 32; i++) {\n    text += possible.charAt(Math.floor(Math.random() * possible.length));\n  }\n  return text;\n}\n\nexport function deactivate() { }\n"],"names":["vscode","fs","path"],"mappings":"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"}